name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on tags starting with 'v' (e.g., v1.0.0, v1.2.3)

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'  # .NET 8 SDK (supports net10.0-windows target framework)
        
    - name: Restore dependencies
      run: dotnet restore AiTranslator/AiTranslator.csproj
      
    - name: Build
      run: dotnet build AiTranslator/AiTranslator.csproj -c Release --no-restore
      
    - name: Publish
      run: dotnet publish AiTranslator/AiTranslator.csproj -c Release -r win-x64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o final --no-build
      
    - name: Get version from tag
      id: get_version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        Write-Host "Tag: $tag, Version: $version"
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: final/AiTranslator.exe
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## Release ${{ steps.get_version.outputs.version }}
          
          ### Changes
          - See commit history for details
          
          ### Installation
          Download `AiTranslator.exe` and run it. No installation required.
          
          ### Build Information
          - Built on: ${{ github.event.head_commit.timestamp }}
          - Commit: ${{ github.sha }}
          - Runner: ${{ runner.os }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
